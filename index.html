<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Умный генератор Рапидо 2</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 10px;
            background: #f5f5f7;
            color: #1c1c1e;
            max-width: 100%;
            margin: 0 auto;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding-bottom: 220px; /* Место для клавиатуры */
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
            color: #0066cc;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #0066cc;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .number {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #0066cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        .number.small {
            background: #ff2d55;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        button:active {
            background: #004499;
        }
        #historyInput {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            resize: none;
            caret-color: transparent;
            pointer-events: none;
            background: white;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        .stats-table th, .stats-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .hot {
            color: #ff2d55;
            font-weight: bold;
        }
        .cold {
            color: #007aff;
            font-weight: bold;
        }
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        /* Кастомная клавиатура */
        .custom-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #e5e5ea;
            padding: 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .keyboard-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .keyboard-key {
            flex: 1;
            height: 50px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .keyboard-key:active {
            background: #d1d1d6;
        }
        .keyboard-key.wide {
            flex: 2;
        }
        .keyboard-key.blue {
            background: #0066cc;
            color: white;
        }
        .keyboard-key.red {
            background: #ff2d55;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Умный генератор Рапидо 2</h1>
            <p class="subtitle">Анализирует историю и предлагает числа</p>
        </div>
        
        <div class="card">
            <h2>Сгенерировать числа</h2>
            <p>Поле 1 (8 из 20):</p>
            <div class="numbers" id="field1"></div>
            <p>Поле 2 (1 из 4):</p>
            <div class="numbers" id="field2"></div>
            <button id="smartGenBtn">Умная генерация</button>
            <button id="randomGenBtn">Случайные числа</button>
        </div>
        
        <div class="card">
            <h2>Добавить историю</h2>
            <textarea 
                id="historyInput" 
                placeholder="Коснитесь для ввода (формат: 1,2,3,4,5,6,7,8 | 1)"
                readonly
            ></textarea>
            <button id="addHistoryBtn">Добавить</button>
        </div>
        
        <div class="card">
            <h2>Статистика чисел (Поле 1)</h2>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Число</th>
                        <th>Выпало раз</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody id="statsTable"></tbody>
            </table>
        </div>
        
        <div class="card">
            <h2>История розыгрышей</h2>
            <div id="historyList"></div>
            <button id="clearHistoryBtn">Очистить историю</button>
        </div>
    </div>

    <!-- Кастомная клавиатура -->
    <div class="custom-keyboard" id="customKeyboard">
        <div class="keyboard-row">
            <div class="keyboard-key" data-key="1">1</div>
            <div class="keyboard-key" data-key="2">2</div>
            <div class="keyboard-key" data-key="3">3</div>
            <div class="keyboard-key red" data-key="Backspace">←</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key" data-key="4">4</div>
            <div class="keyboard-key" data-key="5">5</div>
            <div class="keyboard-key" data-key="6">6</div>
            <div class="keyboard-key" data-key=",">,</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key" data-key="7">7</div>
            <div class="keyboard-key" data-key="8">8</div>
            <div class="keyboard-key" data-key="9">9</div>
            <div class="keyboard-key" data-key="|">|</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key wide" data-key="0">0</div>
            <div class="keyboard-key wide blue" data-key="Enter">✔ Готово</div>
        </div>
    </div>

    <script>
        // Данные
        let history = JSON.parse(localStorage.getItem('rapido2_history')) || [];
        let stats = { field1: {}, field2: {} };
        
        // Элементы интерфейса
        const historyInput = document.getElementById('historyInput');
        const customKeyboard = document.getElementById('customKeyboard');
        const smartGenBtn = document.getElementById('smartGenBtn');
        const randomGenBtn = document.getElementById('randomGenBtn');
        const addHistoryBtn = document.getElementById('addHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            updateHistoryList();
            generateRandomNumbers();
            
            // Обработчики событий
            historyInput.addEventListener('click', showKeyboard);
            smartGenBtn.addEventListener('click', generateSmartNumbers);
            randomGenBtn.addEventListener('click', generateRandomNumbers);
            addHistoryBtn.addEventListener('click', addHistory);
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // Обработчики для клавиатуры
            document.querySelectorAll('.keyboard-key').forEach(key => {
                key.addEventListener('click', handleKeyPress);
            });
            
            // Скрытие клавиатуры при клике вне поля ввода
            document.addEventListener('click', (e) => {
                if (e.target !== historyInput && !customKeyboard.contains(e.target)) {
                    hideKeyboard();
                }
            });
        });

        // ===== Функции клавиатуры =====
        function showKeyboard() {
            customKeyboard.style.display = 'flex';
            // Прокручиваем к полю ввода
            historyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideKeyboard() {
            customKeyboard.style.display = 'none';
        }

        function handleKeyPress(e) {
            const key = e.currentTarget.getAttribute('data-key');
            
            switch(key) {
                case 'Backspace':
                    // Удаление последнего символа
                    historyInput.value = historyInput.value.slice(0, -1);
                    break;
                case 'Enter':
                    // Скрытие клавиатуры
                    hideKeyboard();
                    break;
                default:
                    // Добавление символа
                    historyInput.value += key;
            }
        }

        // ===== Логика генерации чисел =====
        function updateStats() {
            stats = { field1: {}, field2: {} };

            history.forEach(entry => {
                const [field1Str, field2Str] = entry.split(' | ');
                const field1Numbers = field1Str.split(',').map(Number);
                const field2Number = parseInt(field2Str);

                // Поле 1
                field1Numbers.forEach(num => {
                    stats.field1[num] = (stats.field1[num] || 0) + 1;
                });

                // Поле 2
                stats.field2[field2Number] = (stats.field2[field2Number] || 0) + 1;
            });

            renderStatsTable();
        }

        function renderStatsTable() {
            const table = document.getElementById('statsTable');
            table.innerHTML = '';

            // Сортируем по частоте
            const sortedNumbers = Object.entries(stats.field1)
                .sort((a, b) => b[1] - a[1]);

            // Определяем "горячие" и "холодные" числа
            const hotNumbers = sortedNumbers.slice(0, 5).map(item => parseInt(item[0]));
            const coldNumbers = sortedNumbers.slice(-5).map(item => parseInt(item[0]));

            // Заполняем таблицу
            sortedNumbers.forEach(([num, count]) => {
                const row = document.createElement('tr');
                const numCell = document.createElement('td');
                const countCell = document.createElement('td');
                const statusCell = document.createElement('td');

                numCell.textContent = num;
                countCell.textContent = count;

                if (hotNumbers.includes(parseInt(num))) {
                    statusCell.textContent = 'Горячее';
                    statusCell.className = 'hot';
                } else if (coldNumbers.includes(parseInt(num))) {
                    statusCell.textContent = 'Холодное';
                    statusCell.className = 'cold';
                }

                row.appendChild(numCell);
                row.appendChild(countCell);
                row.appendChild(statusCell);
                table.appendChild(row);
            });
        }

        function generateSmartNumbers() {
            const field1Candidates = getWeightedNumbers(stats.field1, 8);
            const field2Candidates = getWeightedNumbers(stats.field2, 1);
            displayNumbers(field1Candidates, field2Candidates);
        }

        function generateRandomNumbers() {
            const field1 = [];
            while (field1.length < 8) {
                const num = Math.floor(Math.random() * 20) + 1;
                if (!field1.includes(num)) field1.push(num);
            }
            field1.sort((a, b) => a - b);

            const field2 = Math.floor(Math.random() * 4) + 1;
            displayNumbers(field1, field2);
        }

        function getWeightedNumbers(numberStats, count) {
            const numbers = Object.keys(numberStats).map(Number);
            const weights = numbers.map(num => numberStats[num] || 1);
            const minWeight = Math.min(...weights);
            const adjustedWeights = weights.map(w => w + minWeight);

            const result = [];
            while (result.length < count) {
                const totalWeight = adjustedWeights.reduce((a, b) => a + b, 0);
                let random = Math.random() * totalWeight;
                let selectedIndex = 0;

                for (let i = 0; i < adjustedWeights.length; i++) {
                    random -= adjustedWeights[i];
                    if (random <= 0) {
                        selectedIndex = i;
                        break;
                    }
                }

                const selectedNum = numbers[selectedIndex];
                if (!result.includes(selectedNum)) {
                    result.push(selectedNum);
                }
            }

            return count === 1 ? result[0] : result.sort((a, b) => a - b);
        }

        function displayNumbers(field1, field2) {
            const field1El = document.getElementById('field1');
            const field2El = document.getElementById('field2');

            field1El.innerHTML = Array.isArray(field1) 
                ? field1.map(num => `<div class="number">${num}</div>`).join('')
                : `<div class="number">${field1}</div>`;

            field2El.innerHTML = `<div class="number small">${field2}</div>`;
        }

        function addHistory() {
            const input = historyInput.value.trim();
            if (!input) return alert("Введите данные!");

            // Проверка формата
            if (!input.includes('|')) {
                return alert("Используйте формат: 1,2,3,4,5,6,7,8 | 1");
            }

            history.push(input);
            localStorage.setItem('rapido2_history', JSON.stringify(history));
            updateStats();
            updateHistoryList();
            historyInput.value = '';
            hideKeyboard();
        }

        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = history.map((item, index) => 
                `<div class="history-item">${index + 1}. ${item}</div>`
            ).join('');
        }

        function clearHistory() {
            if (confirm("Удалить всю историю?")) {
                history = [];
                localStorage.removeItem('rapido2_history');
                updateStats();
                updateHistoryList();
            }
        }
    </script>
</body>
</html>
