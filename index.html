<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Умный генератор Рапидо 2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 10px;
            background: #f5f5f7;
            color: #1c1c1e;
            max-width: 100%;
            margin: 0 auto;
            touch-action: manipulation;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #0066cc;
            text-align: center;
        }
        .numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .number {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #0066cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .number.small {
            background: #ff2d55;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }
        button:active {
            opacity: 0.8;
        }
        textarea {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            resize: none;
            caret-color: #0066cc;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .stats-table th, .stats-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .hot {
            color: #ff2d55;
            font-weight: bold;
        }
        .cold {
            color: #007aff;
            font-weight: bold;
        }

        /* Кастомная клавиатура */
        .custom-keyboard {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #e5e5ea;
            padding: 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
        }
        .keyboard-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .keyboard-key {
            width: 23%;
            height: 50px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        .keyboard-key:active {
            background: #d1d1d6;
        }
        .keyboard-key.wide {
            width: 48%;
        }
        .keyboard-key.blue {
            background: #0066cc;
            color: white;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Умный генератор Рапидо 2</h1>
        <p style="text-align: center;">Анализирует историю и предлагает числа</p>
    </div>

    <div class="card">
        <h2>Сгенерировать числа</h2>
        <div class="numbers" id="field1"></div>
        <div class="numbers" id="field2"></div>
        <button onclick="generateSmartNumbers()">Умная генерация</button>
        <button onclick="generateRandomNumbers()">Случайные числа</button>
    </div>

    <div class="card">
        <h2>Добавить историю</h2>
        <textarea 
            id="historyInput" 
            placeholder="Формат: 1,3,5,7,9,11,13,15 | 2"
            readonly
            onclick="showKeyboard()"
        ></textarea>
        <button onclick="addHistory()">Добавить</button>
    </div>

    <!-- Кастомная клавиатура -->
    <div class="custom-keyboard" id="customKeyboard">
        <div class="keyboard-row">
            <div class="keyboard-key" onclick="insertKey('1')">1</div>
            <div class="keyboard-key" onclick="insertKey('2')">2</div>
            <div class="keyboard-key" onclick="insertKey('3')">3</div>
            <div class="keyboard-key" onclick="insertKey('←')">←</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key" onclick="insertKey('4')">4</div>
            <div class="keyboard-key" onclick="insertKey('5')">5</div>
            <div class="keyboard-key" onclick="insertKey('6')">6</div>
            <div class="keyboard-key" onclick="insertKey(',')">,</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key" onclick="insertKey('7')">7</div>
            <div class="keyboard-key" onclick="insertKey('8')">8</div>
            <div class="keyboard-key" onclick="insertKey('9')">9</div>
            <div class="keyboard-key" onclick="insertKey('|')">|</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key wide" onclick="insertKey('0')">0</div>
            <div class="keyboard-key wide blue" onclick="hideKeyboard()">✔ Готово</div>
        </div>
    </div>

    <script>
        // Данные
        let history = JSON.parse(localStorage.getItem('rapido2_history')) || [];
        let stats = { field1: {}, field2: {} };

        // Загрузка при старте
        updateStats();
        updateHistoryList();

        // ===== Кастомная клавиатура =====
        const keyboard = document.getElementById('customKeyboard');
        const historyInput = document.getElementById('historyInput');

        function showKeyboard() {
            keyboard.style.display = 'block';
            historyInput.focus();
        }

        function hideKeyboard() {
            keyboard.style.display = 'none';
        }

        function insertKey(key) {
            const input = historyInput;
            const startPos = input.selectionStart;
            const endPos = input.selectionEnd;
            
            if (key === '←') {
                // Удаление символа
                if (startPos > 0) {
                    input.value = input.value.substring(0, startPos - 1) + input.value.substring(endPos);
                    input.selectionStart = input.selectionEnd = startPos - 1;
                }
            } else {
                // Вставка символа
                input.value = input.value.substring(0, startPos) + key + input.value.substring(endPos);
                input.selectionStart = input.selectionEnd = startPos + 1;
            }
        }

        // Скрытие клавиатуры при клике вне поля
        document.addEventListener('click', (e) => {
            if (e.target !== historyInput && !keyboard.contains(e.target)) {
                hideKeyboard();
            }
        });

        // ===== Логика генерации чисел =====
        function updateStats() {
            stats = { field1: {}, field2: {} };

            history.forEach(entry => {
                const [field1Str, field2Str] = entry.split(' | ');
                const field1Numbers = field1Str.split(',').map(Number);
                const field2Number = parseInt(field2Str);

                field1Numbers.forEach(num => {
                    stats.field1[num] = (stats.field1[num] || 0) + 1;
                });

                stats.field2[field2Number] = (stats.field2[field2Number] || 0) + 1;
            });

            renderStatsTable();
        }

        function renderStatsTable() {
            const table = document.createElement('tbody');
            table.id = 'statsTable';

            const sortedNumbers = Object.entries(stats.field1)
                .sort((a, b) => b[1] - a[1]);

            const hotNumbers = sortedNumbers.slice(0, 5).map(item => parseInt(item[0]));
            const coldNumbers = sortedNumbers.slice(-5).map(item => parseInt(item[0]));

            sortedNumbers.forEach(([num, count]) => {
                const row = document.createElement('tr');
                const numCell = document.createElement('td');
                const countCell = document.createElement('td');
                const statusCell = document.createElement('td');

                numCell.textContent = num;
                countCell.textContent = count;

                if (hotNumbers.includes(parseInt(num))) {
                    statusCell.textContent = 'Горячее';
                    statusCell.className = 'hot';
                } else if (coldNumbers.includes(parseInt(num))) {
                    statusCell.textContent = 'Холодное';
                    statusCell.className = 'cold';
                }

                row.appendChild(numCell);
                row.appendChild(countCell);
                row.appendChild(statusCell);
                table.appendChild(row);
            });

            const oldTable = document.querySelector('#statsTable');
            if (oldTable) oldTable.replaceWith(table);
        }

        function generateSmartNumbers() {
            const field1Candidates = getWeightedNumbers(stats.field1, 8);
            const field2Candidates = getWeightedNumbers(stats.field2, 1);
            displayNumbers(field1Candidates, field2Candidates);
        }

        function generateRandomNumbers() {
            const field1 = [];
            while (field1.length < 8) {
                const num = Math.floor(Math.random() * 20) + 1;
                if (!field1.includes(num)) field1.push(num);
            }
            field1.sort((a, b) => a - b);

            const field2 = Math.floor(Math.random() * 4) + 1;
            displayNumbers(field1, field2);
        }

        function getWeightedNumbers(numberStats, count) {
            const numbers = Object.keys(numberStats).map(Number);
            const weights = numbers.map(num => numberStats[num] || 1);
            const minWeight = Math.min(...weights);
            const adjustedWeights = weights.map(w => w + minWeight);

            const result = [];
            while (result.length < count) {
                const totalWeight = adjustedWeights.reduce((a, b) => a + b, 0);
                let random = Math.random() * totalWeight;
                let selectedIndex = 0;

                for (let i = 0; i < adjustedWeights.length; i++) {
                    random -= adjustedWeights[i];
                    if (random <= 0) {
                        selectedIndex = i;
                        break;
                    }
                }

                const selectedNum = numbers[selectedIndex];
                if (!result.includes(selectedNum)) {
                    result.push(selectedNum);
                }
            }

            return count === 1 ? result[0] : result.sort((a, b) => a - b);
        }

        function displayNumbers(field1, field2) {
            const field1El = document.getElementById('field1');
            const field2El = document.getElementById('field2');

            field1El.innerHTML = Array.isArray(field1) 
                ? field1.map(num => `<div class="number">${num}</div>`).join('')
                : `<div class="number">${field1}</div>`;

            field2El.innerHTML = `<div class="number small">${field2}</div>`;
        }

        function addHistory() {
            const input = document.getElementById('historyInput').value.trim();
            if (!input) return alert("Введите данные!");

            // Проверка формата
            if (!input.includes('|')) {
                return alert("Используйте формат: 1,2,3,4,5,6,7,8 | 1");
            }

            history.push(input);
            localStorage.setItem('rapido2_history', JSON.stringify(history));
            updateStats();
            updateHistoryList();
            document.getElementById('historyInput').value = '';
            hideKeyboard();
        }

        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = history.map((item, index) => 
                `<div style="padding: 8px; border-bottom: 1px solid #eee;">${index + 1}. ${item}</div>`
            ).join('');
        }

        function clearHistory() {
            if (confirm("Удалить всю историю?")) {
                history = [];
                localStorage.removeItem('rapido2_history');
                updateStats();
                updateHistoryList();
            }
        }

        // Первая генерация
        generateRandomNumbers();
    </script>
</body>
</html>
